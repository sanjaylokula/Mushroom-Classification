---
title: "Mushroom Classification"
author: "Sanjay Lokula"
date: "24/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Loading the Necessary Libraries

```{r}
library(stringr)
library(stringi)
library(car)
library(dplyr)
library(ggplot2)
library(dplyr)
library(corrplot)
library(Seurat)
library(caret)
library(plyr)
library(data.table)

```


#### Loading the Dataset

```{r}
mushroom_data <- read.csv(file.choose(), stringsAsFactors = FALSE)
```


#### Summary of the dataset

```{r}
summary(mushroom_data)
```


#### Class identification

```{r}
str(mushroom_data)
# All type of data are factor

```


#### Missing value analysis
# Let's see is there any NA value and is there any column needs a better name
```{r}
sapply(mushroom_data,function(x)sum(is.na(x)))
# There is no missing value in any column, and all column's name are clear

```

### EDA (Exploratory Data Analysis)

#### Feature Analysis

```{r}

class <- plyr::count(mushroom_data$class)
print(sprintf("Edible: %d | Poisonous: %d | Percent of poisonous classes: %.1f%%",class$freq[1],class$freq[2], round(class$freq[1]/nrow(mushroom_data)*100,1)))
```


#### Analyzing the attributes with low numbers of categories
#### Analyzing "bruises"

```{r}
ggplot(mushroom_data, aes(bruises, fill = class)) + geom_bar(position = "dodge")
```

#### Analyzing gill.attachment
```{r}
ggplot(mushroom_data, aes(gill.attachment, fill = class)) + geom_bar(position = "dodge")

```



#### gill.spacing
```{r}
ggplot(mushroom_data, aes(gill.spacing, fill = class)) + geom_bar(position = "dodge")

```


#### Almost equally distributed classes 

#### gill.size
```{r}
ggplot(mushroom_data, aes(gill.size, fill = class)) + geom_bar(position = "dodge")

```



#### stalk.shape
```{r}
ggplot(mushroom_data, aes(stalk.shape, fill = class)) + geom_bar(position = "dodge")

```


#### odor
```{r}
ggplot(mushroom_data, aes(odor, fill = class)) + geom_bar(position = "dodge")
#Fully Edible: 'a' & 'l'
#Mostly Edible: 'n' (A very small portion of this class fall under poisonous)
#Fully poisonous: 'c', 'f', 'm','p', 's' & 'y'
```




#### Class analysis
##### Calculate number of class for each variable
```{r}
num_of_class <-cbind.data.frame(Var=names(mushroom_data), Total_Class=sapply(mushroom_data,function(x){as.numeric(length(levels(factor(x))))}))
num_of_class

```

### Features analysis Part 2
#### In case if needs to do further investigate so transfter all factor to numeric

```{r}
mushroom_numeric<- sapply(mushroom_data[,1:23], function (x) as.numeric(as.factor(x)))
head(mushroom_numeric)
```




### Correlation analysis
#####  Delete no.17 column of veil-type since it has only one type that is partial
```{r}
cor_mushroom <- cor(mushroom_numeric[, -17])
corrplot.mixed(cor_mushroom,order="AOE")


CombinePlots(plots=list(a,b,c,d,e,f))
a= ggplot(mushroom_data) + geom_bar(aes(x = class))+
  ggtitle("Distribution of class") + ylim(0, 5000)

b = ggplot(mushroom_data) + geom_bar(aes(x = cap.shape))+
  ggtitle("Distribution of cap.shape") + ylim(0, 4000)

c = ggplot(mushroom_data) + geom_bar(aes(x = cap.surface))+
  ggtitle("Distribution of cap.surface") + ylim(0, 4000)

d = ggplot(mushroom_data) + geom_bar(aes(x = cap.color))+
  ggtitle("Distribution of cap.color") + ylim(0, 3000)

e = ggplot(mushroom_data) + geom_bar(aes(x = bruises))+
  ggtitle("Distribution of bruises") + ylim(0, 5000)

f = ggplot(mushroom_data) + geom_bar(aes(x = odor))+
  ggtitle("Distribution of odor") + ylim(0, 4000)

```

### Data Preprocessing

#### Removing veil.type as it has only one factor
#### Converting all the columns to factors 

```{r}
mushroom_data_mod1 <- mushroom_data %>% select(-veil.type)
mushroom_data_mod1[names(mushroom_data_mod1)] <- lapply(mushroom_data_mod1[names(mushroom_data_mod1)], as.factor)
```


#### As the response is a dicotomous value performing logistic regression to check the variable importance

```{r}
model_logistic_test <-  glm(class ~. , data = mushroom_data_mod1, family = binomial(link = logit))
summary(model_logistic_test)
```
#### Identified 10 variables with un-defined coefficients due to singularities.

#### Applying vif
```{r}
vif(model_logistic_test)
```

#### Due to the presence of singularities unable to do VIF
#### Applying alias to identify and remove singularities

```{r}
aliases_round1 <- alias(model_logistic_test)
excluded_factors_round1<- rownames(aliases_round1$Complete)
print(excluded_factors_round1)
```

#### Removing factors show singularities

```{r}

fact_round0 <- model.matrix(~. , mushroom_data_mod1)[,-1]

factors_round1 <- setdiff(colnames(fact_round0), excluded_factors_round1)

mushroom_data_mod2 <- as.data.frame(fact_round0[,factors_round1])
colnames(mushroom_data_mod2)
```
#### Round 2 verification for singularities

```{r}
model_logistic_test2 <-  glm(classp ~. , data = mushroom_data_mod2, family = binomial(link = logit))
summary(model_logistic_test2)
```
#### model summary shows no singularities

#### proceeding with VIF analysis

```{r}
vif_round1 <- vif(model_logistic_test2)
```

#### Multiple factos show VIF greater than 10, Benchmark set to 10

```{r}
vif_df_round1 <- as.data.frame(vif_round1)
setDT(vif_df_round1, keep.rownames = TRUE)[]
vif_rn1_exclude <- filter(vif_df_round1, vif_round1 > 10)[,1]

```
#### Excluded highly correlated factors Round 1

```{r}
vif_fact_round0 <- model.matrix(~. , mushroom_data_mod2)[,-1]

factors_round1 <- setdiff(colnames(vif_fact_round0), vif_rn1_exclude)

mushroom_data_mod3 <- as.data.frame(vif_fact_round0[,factors_round1])
colnames(mushroom_data_mod3)
```

